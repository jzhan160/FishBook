<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <!-- Bootstrap -->
    <link th:href="@{/css/main.css}" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
          crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css" integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz"
          crossorigin="anonymous">
    <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
    <script
            src="http://maps.googleapis.com/maps/api/js?key=AIzaSyBrwKXsz9MEXb7-4gi7JKT_moyf_b6damk&sensor=false">
    </script>

</head>

<body>
<div class="manual-reader manual-container">
    <div th:replace="/widgets/header :: header"></div>

    <header class="jumbotron">
        <div class="container">
            <div class="row row-header">
                <div class="col-12 ">
                    <h1 class="display-4 text-center">xxxxxxxx</h1>
                </div>
            </div>
        </div>
    </header>

    <div id="googleMap" style="width:1000px;height:600px; left: 400px;" ></div>




    <div id="location">
        Your current location.
    </div>

    <div th:text="${session.user.username}">username</div>
</div>


<script>
    var latitude = null;
    var longitude = null;
    var options =
        {
            enableHighAccuracy:true,
            timeout:100,
            maximumAge:0
        }

    function getMyLocation()
    {
        if (navigator.geolocation)
        {
            navigator.geolocation.getCurrentPosition(initialize, displayError, options);
        }
        else
        {
            alert ("oops, no geolocation support");
        }
    }


    function displayError(error)    //error对象有一个code属性，其中包含一个0-3的数。这是用js为各个错误码关联一个错误消息的好方法。
    {
        var errorTypes =   //我们创建的错误消息对象，包括4个属性
            {
                0:"Unknow error",
                1:"Permission denied by user",
                2:"Position is not available",
                3:"Request timed out"
            };
        var errorMessage = errorTypes[error.code];   //将错误对象和error.code进行关联，并赋值给errorMessage
        if (error.code == 0 || error.code == 2)
        {
            errorMessage = errorMessage + "" + error.message;  //对于错误0和2，有时候error.message会有一些额外信息，所以增加进去
        }
        var div = document.getElementById("location");
        div.innerHTML = errorMessage;

        options.timeout += 100;
        navigator.geolocation.getCurrentPosition(initialize, displayError, options);
        div.innerHTML += ".....checking again with timeout=" + options.timeout;
    }

    function displayLocation(position)
    {
        latitude = position.coords.latitude;
        longitude= position.coords.longitude;
        var div = document.getElementById("location");
        div.innerHTML = "You are at Latitude" +  latitude + ", longitude" + longitude;
        div.innerHTML += "(with" + position.coords.accuracy + "meters accuracy)";    //accuracy确定精度，单位为米，越小越精确，越大越不精确
        div.innerHTML += "(found in " + options.timeout + "milliseconds)";

    }


    function initialize(position)
    {
        latitude = position.coords.latitude;
        longitude= position.coords.longitude;
        console.log(latitude);
        console.log(longitude);
        $.ajax({url:"/getData",
            type: "post",
            dataType:"json",
            data: {"lat": latitude,
                "lng": longitude
            },

            success:function(result){ //get locations from backend

                var div = document.getElementById("location");
                div.innerHTML = latitude+''+', '+ longitude;
                var mapProp = {
                    center:new google.maps.LatLng(latitude,longitude),
                    zoom:15,
                    mapTypeId:google.maps.MapTypeId.ROADMAP
                };

                var map=new google.maps.Map(document.getElementById("googleMap"),mapProp);

                for(var i=0;i<result.length;i++){ //add marker to each location
                    var props =  {
                        coords:{lat:result[i].lat,lng:result[i].lng}
                    };
                    console.log(props.coords.lng);
                    var marker = new google.maps.Marker({
                        position:props.coords,
                        map:map,
                        //icon:props.iconImage
                    });

                    /*                        // Check for customicon
                                            if(props.iconImage){
                                                // Set icon image
                                                marker.setIcon(props.iconImage);
                                            }

                                            // Check content
                                            if(props.content){
                                                var infoWindow = new google.maps.InfoWindow({
                                                    content:props.content
                                                });

                                                marker.addListener('click', function(){
                                                    infoWindow.open(map, marker);
                                                });
                                            }*/
                }
            }});


        // Add Marker Function
        /*  function addMarker(props,map){
              var marker = new google.maps.Marker({
                  position:props.coords,
                  map:map,
                  //icon:props.iconImage
              });

              // Check for customicon
              if(props.iconImage){
                  // Set icon image
                  marker.setIcon(props.iconImage);
              }

              // Check content
              if(props.content){
                  var infoWindow = new google.maps.InfoWindow({
                      content:props.content
                  });

                  marker.addListener('click', function(){
                      infoWindow.open(map, marker);
                  });
              }
          }*/
    }
    window.onload = getMyLocation;

</script>
</body>
</html>